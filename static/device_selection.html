<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Device Selection</title>
</head>
<style>
    .device-results li:hover {
        background-color: #b9b9b9;
    }
</style>

<body>
    <div class="topnav">
        <link href="/static/css/top_navigation_style.css" rel="stylesheet">
        <a href="/">Home</a>
        <a href="configuration">Project configuration</a>
        <a class="active" href="device-containers">Device selection</a>
        <a href="logs">Project logs</a>
        <a href="device-control">Device Control</a>
        <a href="swagger/index.html" target="_blank">Swagger</a>
    </div>
    <div id="top-container">
        <div id="device-selection-div">
            <ul class="device-results" id="device-results" style="display: flex;flex-direction: row;flex-wrap: wrap;">
                {{template "device_selection_table" .}}
            </ul>
        </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        // Add listeners to each container info button
        // We have it as a function so we can re-add the listeners each time the table updates
        function addListeners() {
            document.querySelectorAll("#use-device-button").forEach((e) => {
                e.addEventListener("click", (button) => {
                    var container_server_port = button.target.value
                    getDeviceInfo(container_server_port)
                })
            })
        }

        // Get the logs for a device contaienr
        function getDeviceInfo(container_server_port) {
            // Build the url for the respective container logs
            var url = ":" + container_server_port + "/device-info"

            /* Call the endpoint that will get the container logs */
            $.ajax({
                dataType: 'JSON',
                contentType: 'application/json',
                async: false,
                type: "GET",
                url: "http://192.168.1.8" + url,
                success: function (data) {
                },
                error: function (data) {
                }
            });
        }

        // On page load add the listeners and start the refresh containers job
        window.addEventListener("DOMContentLoaded", function () {
            addListeners()
            refreshDevices()
        });

        // Refresh the containers table on the page each 5 seconds
        function refreshDevices() {
            // Call the refresh-ios-containers endpoint
            // And get updated html table for the containers
            $.ajax({
                contentType: 'text/html',
                type: "GET",
                async: false,
                url: "/refresh-available-devices",
                success: function (data) {
                    // Update the containers table with the new table data
                    document.getElementById('device-results').innerHTML = data
                },
                error: function (data) {
                }
            });

            addListeners()

            // Schedule the next refresh
            setTimeout(refreshDevices, 10000);
        }
    </script>
</body>

</html>