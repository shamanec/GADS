<html>

<head>
    <meta charset="UTF-8">
    <title>Device Control</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/jquery.fancytree/2.38.1/skin-lion/ui.fancytree.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css">
</head>
<style>
    .device-info-row {
        display: flex;
        flex-direction: column;
        margin-bottom: 5px;
        text-align: center;
        border-bottom: 1px solid #000000;
        padding-bottom: 5px;
    }

    .device-info-value {
        font-weight: 600;
        margin-top: 2px;
    }

    #device-info {
        padding: 5px;
        margin-top: 2px;
    }

    .action-buttons {
        border-bottom: 1px solid #000000;
        background-color: #32dbb8;
        text-align: center;
        padding: 10px;
        border-radius: 4px;
    }

    .action-buttons:hover {
        background-color: #e8e23f;
        cursor: pointer;
    }

    .fa {
        size: 30px;
    }

    .action-buttons-text {
        user-select: none;
    }

    #device-tools {
        border-radius: 3px;
        min-height: 100px;
        overflow: hidden;
        margin-right: 10px;
        margin-left: 10px;
        width: 250px;
    }

    #container-div {
        display: flex;
        margin-top: 10px;
        margin-left: 10px;
        align-items: flex-start;
        flex-direction: row;
        height: 100%;
    }

    #stream-div {
        margin-right: 10px;
        position: relative;
        border: 1px solid #000;
    }

    #inspector-source {
        width: 500px;
        display: flex;
        flex-direction: column;
        border: 1px solid #000;
    }

    #app-source {
        width: 100%;
        margin-left: 10px;
        list-style: none;
        padding: 0;
        margin: 0;
        background-color: #ffffff;
    }

    #screenshot-div {
        width: 800;
        height: 900;
        overflow: scroll;
        border: 1px solid #000;
        text-align: center;
    }

    ul.fancytree-container {
        border: none;
    }

    span.fancytree-title {
        font-size: 18px;
    }

    .element-info-values {
        font-weight: 600;
        text-align: left;
        max-width: 75%;
    }

    .element-info-keys {
        text-align: center;
        width: 25%;
    }

    .element-info {
        padding: 3px;
        display: flex;
        flex-direction: row;
    }

    #source-container {
        height: 550px;
        display: flex;
        flex-direction: column;
    }

    .app-source-titles {
        top: 0;
        text-align: center;
        font-weight: 600;
        font-size: 20px;
        background-color: #32dbb8;
        border-bottom: 1px solid #000;
        border-top: 1px solid #000;
        padding: 5px;
    }

    #app-source-buttons {
        display: flex;
        flex-direction: row;
        justify-content: center;
        padding: 5px;
        height: 50px;
        background-color: #bdc7c3;
    }

    #element-info-container {
        display: flex;
        flex-direction: column;
    }

    #element-info-holder {
        overflow-y: scroll;
        background-color: #bdc7c3;
    }

    #source-loading {
        display: none;
        height: 100%;
        width: 100%;
    }

    .device-buttons {
        height: 60px;
        width: 100%;
        font-size: 15px;
    }

    /*
        Tabs styling
    */

    .tabs {
        display: flex;
        list-style: none;
        padding: 0px;
    }

    .tab {
        cursor: pointer;
        padding: 10px 20px;
        background-color: #f2f2f2;
        border-radius: 5px;
        margin-right: 10px;
    }

    .tab-content {
        display: none;
    }

    .tab-container {
        width: 100%;
        display: flex;
        flex-direction: column;
        height: 80%;
    }

    /*
        Logs styling
    */
    table,
    td,
    th {
        border: 1px solid #000000;
        text-align: center;
    }

    table {
        border-collapse: collapse;
    }

    td {
        padding: 15px;
        overflow-wrap: anywhere;
    }

    thead th {
        padding: 16px;
        padding-left: 15px;
        border-left: 1px solid #000000;
        border-bottom: 1px solid #000000;
        background: #ffc491;
        text-align: center;
        box-shadow: 0px 0px 0 1px #000000;
        position: sticky;
        top: 0;
    }

    #logs-table {
        overflow-y: auto;
        max-width: 100%;
        border: 1px solid #000;
        text-align: center;
    }

    .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        /* Semi-transparent black overlay */
        z-index: 9999;
    }

    /* Styles for the loader */
    .loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 8px solid #f3f3f3;
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 2s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<body>
    <div class="overlay" id="overlay">
        <div class="loader"></div>
    </div>
    <div class="topnav">
        <link href="/static/css/top_navigation_style.css" rel="stylesheet">
        <a href="/">Home</a>
        <a href="/logs">Logs</a>
        <a href="selenium-grid">Selenium Grid</a>
    </div>
    <div id="container-div">
        <div>
            <button class="action-buttons" id="back-to-devices" onclick="location.href = '/devices';"><i
                    class="fa-solid fa-left-long"></i>
                Back to devices</button>
        </div>
        <div id="device-tools">
            <div>
                <button class="device-buttons action-buttons" id="home-screen"><i class="fa-solid fa-home"></i>
                    Homescreen</button>
            </div>
            <div>
                <button class="device-buttons action-buttons" id="lock-device"><i class="fa-solid fa-lock"></i> Lock
                    device</button>
            </div>
            <div>
                <button class="device-buttons action-buttons" id="unlock-device"><i class="fa-solid fa-unlock"></i>
                    Unlock device</button>
            </div>
            <div>
                <button class="device-buttons action-buttons" id="type-text"><i class="fa-solid fa-pencil"></i> Type
                    text</button>
                <input type="text" id="type-text-input" style="width: 100%;" placeholder="Type text here">
            </div>
            <div>
                <button class="device-buttons action-buttons" id="clear-text"><i class="fa-solid fa-eraser"></i> Clear
                    text</button>
            </div>
            <div>
                <button class="device-buttons action-buttons" id="refresh-session"><i class="fa-solid fa-refresh"></i>
                    Refresh session</button>
            </div>
            <div id="device-info">
                <div class="device-info-row">
                    <div>OS:</div>
                    <div class="device-info-value">{{.Device.OSVersion}}</div>
                </div>
                <div class="device-info-row">
                    <div>UDID:</div>
                    <div class="device-info-value">{{.Device.UDID}}</div>
                </div>
            </div>
        </div>
        <div id="stream-div">
            <canvas id="actions-canvas"
                style="position: absolute;width: {{.CanvasWidth}};height: {{.CanvasHeight}};"></canvas>
            {{ if eq .Device.OS "ios"}}
            <img id="image-stream" style="width: {{.CanvasWidth}}px;height: {{.CanvasHeight}}px;"></img>
            {{else}}
            <img id="image-stream" style="width: {{.CanvasWidth}}px;height: {{.CanvasHeight}}px;"></img>
            {{end}}
        </div>
        <div class="tab-container">
            <ul class="tabs">
                <li class="tab" onclick="openTab('inspector-source')">Inspector</li>
                <li class="tab" onclick="openTab('screenshot-div')">Screenshot</li>
                <li class="tab" onclick="openTab('logs-table')">Logs</li>
            </ul>
            <div id="inspector-source" class="tab-content">
                <div id="app-source-buttons">
                    <div style="margin-right: 10px;">
                        <button class="action-buttons" id="refresh-source"><i class="fa-solid fa-rotate"></i> Get
                            source</button>
                    </div>
                    <div>
                        <button class="action-buttons" id="wipe-canvas"><i class="fa-solid fa-broom"></i> Wipe
                            canvas</button>
                    </div>
                </div>
                <div id="source-container">
                    <div class="app-source-titles">App source</div>
                    <div id="source-loading">
                        <img style="object-fit: contain; height: 100%;" src="/static/images/gears.gif">
                    </div>
                    <div style="overflow: auto;">
                        <div id="app-source"></div>
                    </div>
                </div>
                <div id="element-info-container">
                    <div class="app-source-titles">Element info</div>
                    <div id="element-info-holder">
                        {{if eq .Device.OS "ios"}}
                        <div class="element-info">
                            <div class="element-info-keys">type</div>
                            <div class="element-info-values" id="element-type">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">name</div>
                            <div class="element-info-values" id="element-name">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">label</div>
                            <div class="element-info-values" id="element-label">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">visible</div>
                            <div class="element-info-values" id="element-visible">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">enabled</div>
                            <div class="element-info-values" id="element-enabled">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">value</div>
                            <div class="element-info-values" id="element-value">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">x</div>
                            <div class="element-info-values" id="element-x">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">y</div>
                            <div class="element-info-values" id="element-y">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">width</div>
                            <div class="element-info-values" id="element-width">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">height</div>
                            <div class="element-info-values" id="element-height">none</div>
                        </div>
                        {{else}}
                        <div class="element-info">
                            <div class="element-info-keys">index</div>
                            <div class="element-info-values" id="element-index">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">resource-id</div>
                            <div class="element-info-values" id="element-resourceid">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">package</div>
                            <div class="element-info-values" id="element-package">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">class</div>
                            <div class="element-info-values" id="element-class">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">text</div>
                            <div class="element-info-values" id="element-text">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">checkable</div>
                            <div class="element-info-values" id="element-checkable">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">checked</div>
                            <div class="element-info-values" id="element-checked">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">clickable</div>
                            <div class="element-info-values" id="element-clickable">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">enabled</div>
                            <div class="element-info-values" id="element-enabled">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">focusable</div>
                            <div class="element-info-values" id="element-focusable">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">focused</div>
                            <div class="element-info-values" id="element-focused">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">long-clickable</div>
                            <div class="element-info-values" id="element-long-clickable">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">password</div>
                            <div class="element-info-values" id="element-password">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">scrollable</div>
                            <div class="element-info-values" id="element-scrollable">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">selected</div>
                            <div class="element-info-values" id="element-selected">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">bounds</div>
                            <div class="element-info-values" id="element-bounds">none</div>
                        </div>
                        <div class="element-info">
                            <div class="element-info-keys">displayed</div>
                            <div class="element-info-values" id="element-displayed">none</div>
                        </div>
                        {{end}}
                    </div>
                </div>
            </div>
            <div id="screenshot-div" class="tab-content">
                <button class="device-buttons action-buttons" id="screenshot"><i class="fa-solid fa-camera"></i>
                    Screenshot</button>
                <img id="screenshot-image">
            </div>
            <table id="logs-table" class="tab-content">
                <thead>
                    <tr>
                        <th style="width: 10%;">Timestamp</th>
                        <th style="width: 5%;">Level</th>
                        <th style="width: 10%;">Event</th>
                        <th style="width: 75%;">Message</th>
                    </tr>
                </thead>
                <tbody id="logs-table-body">
                </tbody>
            </table>

        </div>

    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.fancytree/2.38.1/jquery.fancytree-all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/jquery.fancytree/2.38.1/jquery.fancytree-all-deps.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
<script>
    const hostname = window.location.hostname
    const port = window.location.port
    let domain = 'http://' + hostname + (port ? ':' + port : '')

    let device_host = "{{.Device.HostAddress}}"
    let device_os = "{{.Device.OS}}"
    let canvas_width = "{{.CanvasWidth}}"
    let canvas_height = "{{.CanvasHeight}}"
    let screen_size = "{{.Device.ScreenSize}}"
    document.getElementById("refresh-source").addEventListener('click', () => {
        getAppSource()
    })

    var iosStreamSocket = null
    var androidStreamSocket = null
    var logsSocket = null
    var inUseSocket = null

    setIosStream()
    setAndroidStream()
    getLogs()
    setInUse()

    window.onload = function () {
    };

    document.addEventListener("DOMContentLoaded", function () {
    });

    function showOverlay() {
        overlay.style.display = 'block';
    }

    // Function to hide the overlay
    function hideOverlay() {
        overlay.style.display = 'none'
    }

    function showFailedSessionAlert() {
        const swalWithBootstrapButtons = Swal.mixin({
            customClass: {
                confirmButton: 'btn btn-success',
                cancelButton: 'btn btn-danger'
            },
            buttonsStyling: true
        })

        swalWithBootstrapButtons.fire({
            title: 'Session lost',
            text: "Do you want to refresh or go back to devices?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Refresh session',
            cancelButtonText: 'Back to devices',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                refreshSession()
            } else if (
                result.dismiss === Swal.DismissReason.cancel
            ) {
                window.location.href = domain + "/devices";
            }
        })
    }

    async function refreshSession() {
        let url = domain + "/device/{{.Device.UDID}}/health"
        showOverlay()
        await fetch(url, {
            method: 'GET'
        }).catch((error) => {
            window.location.href = domain + "/devices";
            window.location.reload();
        })
        hideOverlay()
    }

    document.getElementById("refresh-session").addEventListener('click', () => {
        refreshSession()
    })

    function openTab(tabName) {
        var i;
        var tabContents = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabContents.length; i++) {
            tabContents[i].style.display = "none";
        }
        document.getElementById(tabName).style.display = "block";
    }

    function setInUse() {
        inUseSocket = new WebSocket("ws://" + device_host + ":10000/devices/control/{{.Device.UDID}}/in-use")
        if (inUseSocket.readyState === WebSocket.OPEN) {
            inUseSocket.send('ping');
        }
        const pingInterval = setInterval(() => {
            if (inUseSocket.readyState === WebSocket.OPEN) {
                inUseSocket.send('ping');
            }
        }, 1000);
    }

    function setIosStream() {
        if (device_os == 'ios') {
            // Connect to the ios device streaming websocket
            iosStreamSocket = new WebSocket("ws://" + device_host + ":10001/device/{{.Device.UDID}}/ios-stream")
            let imgElement = document.getElementById('image-stream')
            iosStreamSocket.onmessage = function (event) {
                const imageURL = URL.createObjectURL(event.data);
                imgElement.src = imageURL

                imgElement.onload = () => {
                    URL.revokeObjectURL(imageURL);
                };
            }
        }
    }

    function setAndroidStream() {
        if (device_os == 'android') {
            // Connect to the android device streaming websocket
            androidStreamSocket = new WebSocket("ws://" + device_host + ":10001/device/{{.Device.UDID}}/android-stream")
            // Set the type of the socket, did not work otherwise
            androidStreamSocket.binaryType = 'arraybuffer'

            let imgElement = document.getElementById('image-stream')
            androidStreamSocket.onmessage = function (event) {
                // Get the message data
                const data = event.data
                // Get the first 4 bytes of the message to Int
                // To determing the message type - info or image
                const messageType = new DataView(data.slice(0, 4)).getInt32(0, false)

                // If message type is 1(Info)
                if (messageType == 1) {
                    const width = new DataView(data.slice(4, 8)).getInt32(0, false)
                    const height = new DataView(data.slice(8, 12)).getInt32(0, false)
                }

                // If message type is 2(Image)
                if (messageType == 2) {
                    // Create an image URL
                    const imageURL = URL.createObjectURL(new Blob([data.slice(4)]))
                    // Set the image in the image element to create a stream
                    imgElement.src = imageURL

                    imgElement.onload = () => {
                        URL.revokeObjectURL(imageURL);
                    };
                }
            }
        }
    }

    function getLogs() {
        logsSocket = new WebSocket("ws://" + hostname + ":" + port + "/logs-ws?collection={{.Device.UDID}}")
        logsSocket.onmessage = function (event) {
            var json = JSON.parse(event.data)
            createLogsTable(json)
        };
    }

    function createLogsTable(json) {
        var table = document.getElementById("logs-table-body");

        for (let i = json.length - 1; i >= 0; i--) {
            if (json[i].message == "") {
                continue
            }

            var tr = document.createElement('tr');
            tr.id = "table-row"

            var td2 = document.createElement('td');
            var td3 = document.createElement('td');
            var td4 = document.createElement('td');
            var td5 = document.createElement('td');

            const date = moment(json[i].timestamp);

            // Format the date as per your desired format
            const formattedDate = date.format("DD-MM-YYYY HH:mm:ss.SSS");

            var timestamp = document.createTextNode(formattedDate);
            var level = document.createTextNode(json[i].level);
            var event = document.createTextNode(json[i].eventname);
            var message = document.createTextNode(json[i].message);

            td2.appendChild(timestamp);
            td3.appendChild(level);
            td4.appendChild(event);
            td5.appendChild(message);
            tr.appendChild(td2);
            tr.appendChild(td3);
            tr.appendChild(td4);
            tr.appendChild(td5);

            if (level.textContent === "error") {
                tr.style.backgroundColor = "#ff8330"
            } else if (level.textContent === "info") {
                tr.style.backgroundColor = "#b7eb34"
            } else if (level.textContent === "fatal") {
                tr.style.backgroundColor = "#ff8330"
            } else if (level.textContent === "debug") {
                tr.style.backgroundColor = "#ffe330"
            } else if (level.textContent === "warning") {
                tr.style.backgroundColor = "#ff8330"
            }

            table.insertBefore(tr, table.firstChild)
        }
    }

    document.getElementById("back-to-devices").addEventListener('click', () => {
        if (iosStreamSocket != null) {
            iosStreamSocket.close()
        }

        if (androidStreamSocket != null) {
            androidStreamSocket.close()
        }

        if (logsSocket != null) {
            logsSocket.close()
        }
    })

    document.getElementById("home-screen").addEventListener('click', () => {
        let url = domain + "/device/{{.Device.UDID}}/home"
        fetch(url, {
            method: 'POST'
        })
            .then(response => {
                if (response.status === 404) {
                    showFailedSessionAlert()
                    return
                }
            })
            .catch(function (error) {
                alert("Could not access device homescreen endpoint. Error: " + error)
            })
    })

    document.getElementById("unlock-device").addEventListener('click', () => {
        let url = domain + "/device/{{.Device.UDID}}/unlock"
        fetch(url, {
            method: 'POST'
        }).then(response => {
            if (response.status === 404) {
                showFailedSessionAlert()
                return
            }
        }).catch(function (error) {
            alert("Could not access device unlock endpoint. Error: " + error)
        })
    })

    document.getElementById("lock-device").addEventListener('click', () => {
        let url = domain + "/device/{{.Device.UDID}}/lock"
        fetch(url, {
            method: 'POST'
        })
            .then(response => {
                if (response.status === 404) {
                    showFailedSessionAlert()
                    return
                }
            })
            .catch(function (error) {
                alert("Could not access device lock endpoint. Error: " + error)
            })
    })

    document.getElementById("screenshot").addEventListener('click', () => {
        let url = domain + "/device/{{.Device.UDID}}/screenshot"
        fetch(url, {
            method: 'POST'
        })
            .then((response) => {
                if (response.status === 404) {
                    showFailedSessionAlert()
                    return
                }
                return response.json()
            })
            .then(screenshotJson => {
                var imageBase64String = screenshotJson.value
                const image = document.getElementById('screenshot-image')
                image.src = "data:image/png;base64," + imageBase64String
            })
            .catch(function (error) {
                alert("Could not take screenshot. Error: " + error)
            })
    })

    document.getElementById("type-text").addEventListener('click', () => {
        typeText()
    })

    document.getElementById("clear-text").addEventListener('click', () => {
        clearActiveElementText()
    })

    document.getElementById("wipe-canvas").addEventListener('click', () => {
        wipeCanvas()
    })

    async function typeText() {
        let url = domain + "/device/{{.Device.UDID}}/typeText"
        var text_input = document.getElementById("type-text-input").value
        await fetch(url, {
            method: 'POST',
            headers: {
                'Content-type': 'application/json'
            },
            body: JSON.stringify({ "text": text_input })
        }).then((response) => {
            if (response.status === 404) {
                document.getElementById("type-text-input").value = ""
                showFailedSessionAlert()
                return
            }
            document.getElementById("type-text-input").value = ""
        })
    }

    async function clearActiveElementText() {
        let url = domain + "/device/{{.Device.UDID}}/clearText"
        var text_input = document.getElementById("type-text-input").value
        await fetch(url, {
            method: 'POST'
        }).then((response) => {
            if (response.status === 404 || response.status === 500) {
                showFailedSessionAlert()
                return
            }
        })
    }

    //=============CANVAS INTERACTIONS===================//
    // canvas over the WDA image stream that allows us to tap
    // and also draw element rectangles
    var canvas = document.getElementById("actions-canvas")

    var tapStartAt = 0
    var coord1;
    var coord2;

    canvas.addEventListener('mousedown', () => {
        // get the time of clicking the canvas
        tapStartAt = (new Date()).getTime()
        // get the initial coordinates of clicking the canvas
        coord1 = getCursorCoordinates(canvas, event)
        applyCursorRippleEffect(event);
    })

    canvas.addEventListener('mouseup', () => {
        // get the coordinates on finishing the click on the canvas
        coord2 = getCursorCoordinates(canvas, event)
        // get the time of finishing the click on the canvas
        var tapEndAt = (new Date()).getTime()

        var mouseEventsTimeDiff = tapEndAt - tapStartAt

        // if the difference of time between click down and click up is more than 500ms assume it is a swipe, not a tap
        // to allow flick swipes we also check the difference between the gesture coordinates
        // x1, y1 = mousedown coordinates
        // x2, y2 = mouseup coordinates
        // if x2 > x1*1.1 - it is probably a swipe left to right
        // if x2 < x1*0.9 - it is probably a swipe right to left
        // if y2 < y1*0.9 - it is probably a swipe bottom to top
        // if y2 > y1*1.1 - it is probably a swipe top to bottom
        if (mouseEventsTimeDiff > 500 || coord2[0] > coord1[0] * 1.1 || coord2[0] < coord1[0] * 0.9 || coord2[1] < coord1[1] * 0.9 || coord2[1] > coord1[1] * 1.1) {
            performSwipe(coord1, coord2)
        } else {
            // else perform a simple tap at coordinates
            tapCoordinates(coord1)
        }
    })

    // get the coordinates of the cursor position of the canvas tap event
    function getCursorCoordinates(canvas, event) {
        // get the canvas rectangle and then the coordinates of the tap event
        const rect = canvas.getBoundingClientRect()
        const x = event.clientX - rect.left
        const y = event.clientY - rect.top
        return [x, y];
    }

    // tap with WDA using coordinates
    function tapCoordinates(pos) {
        // get stream size and ratio
        let stream_size_ratio = (canvas_height / canvas_width).toFixed(2)

        // get device screen size dimensions
        let dimensions = screen_size.split('x');
        let deviceHeight = parseInt(dimensions[1], 10)
        let deviceWidth = parseInt(dimensions[0], 10)

        // set initial x and y tap coordinates
        let x = pos[0]
        let y = pos[1]

        // if the stream height 
        if (canvas_height != deviceHeight) {
            x = (pos[0] / canvas_width) * deviceWidth
            y = (pos[1] / canvas_height) * deviceHeight
        }

        let jsonData = JSON.stringify({
            "x": x,
            "y": y
        })

        let url = domain + "/device/{{.Device.UDID}}/tap"

        fetch(url, {
            method: 'POST',
            body: jsonData,
            headers: {
                'Content-type': 'application/json'
            }
        })
            .then(response => {
                if (response.status === 404) {
                    showFailedSessionAlert()
                    return
                }
            })
            .catch(function (error) {
                alert("Could not access device homescreen endpoint. Error: " + error)
            })
    }

    function performSwipe(coord1, coord2) {

        var firstCoordX = coord1[0]
        var firstCoordY = coord1[1]
        var secondCoordX = coord2[0]
        var secondCoordY = coord2[1]

        let stream_size_ratio = (canvas_height / canvas_width).toFixed(2)

        // get device screen size dimensions
        let dimensions = screen_size.split('x');
        let deviceHeight = parseInt(dimensions[1], 10)
        let deviceWidth = parseInt(dimensions[0], 10)

        // if the stream height 
        if (canvas_height != deviceHeight) {
            firstCoordX = (firstCoordX / canvas_width) * deviceWidth
            firstCoordY = (firstCoordY / canvas_height) * deviceHeight
            secondCoordX = (secondCoordX / canvas_width) * deviceWidth
            secondCoordY = (secondCoordY / canvas_height) * deviceHeight
        }

        let jsonData = JSON.stringify({
            "x": firstCoordX,
            "y": firstCoordY,
            "endX": secondCoordX,
            "endY": secondCoordY
        })

        let url = domain + "/device/{{.Device.UDID}}/swipe"

        fetch(url, {
            method: 'POST',
            body: jsonData,
            headers: {
                'Content-type': 'application/json'
            }
        })
            .then(response => {
                if (response.status === 404) {
                    showFailedSessionAlert()
                    return
                }
            })
            .catch(function (error) {
                alert("Could not access device homescreen endpoint. Error: " + error)
            })

    }

    function applyCursorRippleEffect(e) {
        const ripple = document.createElement("div");

        ripple.className = "ripple";
        document.body.appendChild(ripple);

        ripple.style.left = `${e.clientX}px`;
        ripple.style.top = `${e.clientY}px`;

        ripple.style.animation = "ripple-effect .2s  linear";
        ripple.onanimationend = () => document.body.removeChild(ripple);
    }

    function wipeCanvas() {
        const canvas = document.getElementById('actions-canvas')
        const context = canvas.getContext('2d')
        context.clearRect(0, 0, canvas.width, canvas.height);
    }

    // draw a rectangle for element selected by the app source tree
    // get the element coordinates and size from fancytree node value and build a rectangle on the stream canvas
    // showing the selected element
    function drawRectangleForTree(json) {
        // clear the canvas before drawing a new object
        wipeCanvas()
        const canvas = document.getElementById('actions-canvas')
        const context = canvas.getContext('2d')
        context.fillStyle = "rgba(232, 226, 63, 0.5)";

        let stream_height = canvas.height
        let stream_width = canvas.width

        // get device screen size dimensions
        let dimensions = screen_size.split('x');
        let device_height = parseInt(dimensions[1], 10)
        let device_width = parseInt(dimensions[0], 10)

        let elementX;
        let elementY;
        let elementWidth;
        let elementHeight;
        let appium_height;

        if (device_os == "ios") {
            // get the selected element coordinates and width/height from the json
            elementX = json.x;
            elementY = json.y;
            elementWidth = json.width;
            elementHeight = json.height;
        } else {
            // Get the bounds which are two separate arrays next to each other
            let element_bounds = json.bounds

            // Change the initial bounds string into two values separated by :
            let element_bounds_no_brackets = element_bounds.replaceAll("][", ":").replaceAll("[", "").replaceAll("]", "")

            // Split the separated values into two different arrays
            let bounds_array = element_bounds_no_brackets.split(":")

            // Get the start coordinates from the first bounds array index into their own array
            let start_coordinates = bounds_array[0].split(",")

            // Get the end coordinates from the second bounds array index into their own array
            let end_coordinates = bounds_array[1].split(",")

            // Set the element actual coordinates based on the final arrays
            // Element starting X is the first value of the first array
            elementX = start_coordinates[0]
            // Element starting Y is the second value of the first array
            elementY = start_coordinates[1]
            // Element width is equal to the ending X coordinate from the second array minus the starting X coordinate from the first array
            elementWidth = end_coordinates[0] - start_coordinates[0]
            // Element height is equal to the ending Y coordinate from the second array minus the starting Y coordinate from the first array
            elementHeight = end_coordinates[1] - start_coordinates[1]
        }

        // If the stream height is different than the device screen height
        // Recalculate the element coordinates and width/height
        if (stream_height != device_height) {

            elementX = (elementX / device_width) * stream_width
            elementY = (elementY / device_height) * stream_height
            elementWidth = (elementWidth / device_width) * stream_width
            elementHeight = (elementHeight / device_height) * stream_height

            // draw the rectangle on the canvas using the recalculated element coordinate values
            context.fillRect(
                elementX,
                elementY,
                elementWidth,
                elementHeight
            );
        } else {
            // if the stream height is the same as the device screen height just draw the rectangle with the original values
            context.fillRect(
                elementX,
                elementY,
                elementWidth,
                elementHeight
            );
        }

        console.log(elementX)
        console.log(elementY)
        console.log(elementWidth)
        console.log(elementHeight)
    }

    //=============APP SOURCE===================//
    function getAppSource() {
        var url = domain + "/device/{{.Device.UDID}}/appiumSource"
        let app_source = $('#app-source')
        parser = new DOMParser();

        showSourceLoading()
        fetch(url, {
            method: 'GET',
        })
            .then((response) => {
                if (response.status === 404) {
                    showFailedSessionAlert()
                    return
                }
                return response.json()
            })
            .then((json) => {
                // parse the xml doc from the Appium response xml
                xmlDoc = parser.parseFromString(json.value, "text/xml");

                // parse the xml response into a json format accepted by jstree
                if (device_os == "android") {
                    var jstree_json = androidGenerateJSONForTreeFromXML(xmlDoc.documentElement)
                } else {
                    var jstree_json = iOSGenerateJSONForTreeFromXML(xmlDoc.documentElement)
                }

                // If the tree already exists and has children - reload it with the new data
                // If the tree doesn't exist or doesn't have children - initialize it for the first time with the needed options
                if (app_source.children().length > 0) {
                    $.ui.fancytree.getTree().reload(JSON.parse(jstree_json));
                    setTimeout(hideSourceLoading(), 1000)
                } else {
                    app_source.fancytree({
                        'source': [
                            JSON.parse(jstree_json)
                        ],
                        activate: function (event, data) {
                            console.log(data.node.key)
                            var element_values = JSON.parse(data.node.key.replaceAll("'", "\""))
                            showElementInfo(element_values)
                            drawRectangleForTree(element_values)
                        }
                    });
                    setTimeout(hideSourceLoading(), 1000)
                }
            })
            .catch(function (error) {
                alert("Could not get app source. Error: " + error)
                hideSourceLoading()
            })
    }

    // read the Appium xml for an iOS device and transform it into a json accepted by fancytree
    function iOSGenerateJSONForTreeFromXML(node) {
        if (node.nodeType != 1) return "";

        // Get all the data from the xml doc returned by Appium
        var elemType = node.getAttribute('type')
        var elemX = node.getAttribute('x')
        var elemY = node.getAttribute('y')
        var elemWidth = node.getAttribute('width')
        var elemHeight = node.getAttribute('height')
        var elemName = node.getAttribute('name')
        var elemLabel = node.getAttribute('label')
        var elemVisible = node.getAttribute('visible')
        var elemEnabled = node.getAttribute('enabled')
        var elemValue = node.getAttribute('value')

        // this is not a valid json but this is the only way I could find to embed it inside another json (bad developer)
        // it is reworked later into valid json that can be parsed
        value_json = `{'type':'` + elemType + `',` +
            `'x':'` + elemX + `',` +
            `'y':'` + elemY + `',` +
            `'width':'` + elemWidth + `',` +
            `'height':'` + elemHeight + `',` +
            `'name':'` + elemName + `',` +
            `'label':'` + elemLabel + `',` +
            `'visible':'` + elemVisible + `',` +
            `'enabled':'` + elemEnabled + `',` +
            `'value':'` + elemValue + `'}`

        // for each node open with an object
        // the key is the "json" (quotes intended) that will we will read later upon clicking a node in the tree
        // no icons since its not a folder/file structure
        // no lazy loading - the whole tree is loaded
        // no default active nodes in the tree
        // title is the element type
        var mainJson = `{"key":"` + value_json + `", "icon": false, "lazy": false, "active": false,"title":"` + node.nodeName + `"`
        var jsonForChildNodes = "";

        // if the node has children open the children array
        if (node.childNodes.length > 0) {
            mainJson += `, "children":[`
        }
        for (var i = 0; i < node.childNodes.length; i++) {
            // for each child of the main node generate deeper json objects
            jsonForChildNodes += iOSGenerateJSONForTreeFromXML(node.childNodes[i]);
        }
        if (jsonForChildNodes) {
            // close the children array
            mainJson += jsonForChildNodes + `]`
        }
        // close the json object
        mainJson += `}`

        // cus I am a bad developer I couldn't think of the proper way to 
        // build the json with all needed commas so I invented this solution
        // to add the missing commas to make the json valid xD
        mainJson = mainJson.replaceAll("}{", "},{")
        return mainJson;
    }

    // read the Appium xml for an Android device and transform it into a json accepted by fancytree
    function androidGenerateJSONForTreeFromXML(node) {
        if (node.nodeType != 1) return "";

        // Get all the data from the xml doc returned by Appium
        var index = node.getAttribute('index')
        var package = node.getAttribute('package')
        var element_class = node.getAttribute('class')
        var text = node.getAttribute('text')
        var checkable = node.getAttribute('checkable')
        var checked = node.getAttribute('checked')
        var clickable = node.getAttribute('clickable')
        var enabled = node.getAttribute('enabled')
        var focusable = node.getAttribute('focusable')
        var focused = node.getAttribute('focused')
        var long_clickable = node.getAttribute('long-clickable')
        var password = node.getAttribute('password')
        var scrollable = node.getAttribute('scrollable')
        var selected = node.getAttribute('false')
        var bounds = node.getAttribute('bounds')
        var displayed = node.getAttribute('displayed')
        var resource_id = node.getAttribute('resource-id')

        // this is not a valid json but this is the only way I could find to embed it inside another json (bad developer)
        // it is reworked later into valid json that can be parsed
        value_json = `{'index':'` + index + `',` +
            `'package':'` + package + `',` +
            `'class':'` + element_class + `',` +
            `'text':'` + text + `',` +
            `'checkable':'` + checkable + `',` +
            `'checked':'` + checked + `',` +
            `'clickable':'` + clickable + `',` +
            `'enabled':'` + enabled + `',` +
            `'focusable':'` + focusable + `',` +
            `'focused':'` + focused + `',` +
            `'longclickable':'` + long_clickable + `',` +
            `'password':'` + password + `',` +
            `'scrollable':'` + scrollable + `',` +
            `'selected':'` + selected + `',` +
            `'bounds':'` + bounds + `',` +
            `'resourceid':'` + resource_id + `',` +
            `'displayed':'` + displayed + `'}`

        // for each node open with an object
        // the key is the "json" (quotes intended) that will we will read later upon clicking a node in the tree
        // no icons since its not a folder/file structure
        // no lazy loading - the whole tree is loaded
        // no default active nodes in the tree
        // title is the element type
        var mainJson = `{"key":"` + value_json + `", "icon": false, "lazy": false, "active": false,"title":"` + node.nodeName + `"`
        var jsonForChildNodes = "";

        // if the node has children open the children array
        if (node.childNodes.length > 0) {
            mainJson += `, "children":[`
        }
        for (var i = 0; i < node.childNodes.length; i++) {
            // for each child of the main node generate deeper json objects
            jsonForChildNodes += androidGenerateJSONForTreeFromXML(node.childNodes[i]);
        }
        if (jsonForChildNodes) {
            // close the children array
            mainJson += jsonForChildNodes + `]`
        }
        // close the json object
        mainJson += `}`

        // cus I am a bad developer I couldn't think of the proper way to 
        // build the json with all needed commas so I invented this solution
        // to add the missing commas to make the json valid xD
        mainJson = mainJson.replaceAll("}{", "},{")
        return mainJson;
    }

    function showElementInfo(json) {

        if (device_os == "ios") {
            $("#element-type").text(json.type)
            $("#element-name").text(json.name)
            $("#element-label").text(json.label)
            $("#element-value").text(json.value)
            $("#element-enabled").text(json.enabled)
            $("#element-visible").text(json.visible)
            $("#element-x").text(json.x)
            $("#element-y").text(json.y)
            $("#element-width").text(json.width)
            $("#element-height").text(json.height)
        } else {
            $("#element-index").text(json.index)
            $("#element-resourceid").text(json.resourceid)
            $("#element-package").text(json.package)
            $("#element-class").text(json.class)
            $("#element-text").text(json.text)
            $("#element-checkable").text(json.checkable)
            $("#element-checked").text(json.checked)
            $("#element-clickable").text(json.clickable)
            $("#element-enabled").text(json.enabled)
            $("#element-focusable").text(json.focusable)
            $("#element-focused").text(json.focused)
            $("#element-long-clickable").text(json.longclickable)
            $("#element-password").text(json.password)
            $("#element-scrollable").text(json.scrollable)
            $("#element-selected").text(json.selected)
            $("#element-bounds").text(json.bounds)
            $("#element-displayed").text(json.displayed)
        }

    }

    function showSourceLoading() {
        let tree = document.getElementById("app-source")
        tree.style.display = "none"

        let loading = document.getElementById("source-loading")
        loading.style.display = "flex"
    }

    function hideSourceLoading() {
        let tree = document.getElementById("app-source")
        tree.style.display = "block"

        let loading = document.getElementById("source-loading")
        loading.style.display = "none"
    }


</script>

</html>