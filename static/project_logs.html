<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Project logs</title>
</head>
<style>
    table,
    td,
    th {
        border: 1px solid #000000;
        text-align: center;
    }

    table {
        border-collapse: collapse;
        width: 100%;
    }

    td {
        padding: 15px;
    }

    thead th {
        padding: 16px;
        padding-left: 15px;
        border-left: 1px solid #000000;
        border-bottom: 1px solid #000000;
        background: #ffc491;
        text-align: center;
        box-shadow: 0px 0px 0 1px #000000;
    }

    /* Set header to stick to the top of the container. */
    thead tr th {
        position: sticky;
        top: 50px;
    }

    .topnav {
        position: sticky;
        top: 0;
    }

    .log-selection {
        background-color: #32dbb8;
        border: none;
        padding: 12px 16px;
        font-size: 16px;
        cursor: pointer;
        margin: 5px;
    }

    .loading {
        position: absolute;
        display: block;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        background-color: rgba(70, 70, 70, .5);
        color: red;
    }
</style>

<body>
    <div class="topnav">
        <link href="/static/css/top_navigation_style.css" rel="stylesheet">
        <a href="/">Home</a>
        <a class="active" href="logs">Logs</a>
        <a href="devices">Devices</a>
        <a href="selenium-grid">Selenium Grid</a>
    </div>
    {{range .Providers}}
    <button class="log-selection provider-buttons" value="{{.Name}}" style="margin-bottom: 10px;">{{.Name}}</button>
    {{end}}
    <table id="logs-table">
        <thead>
            <tr>
                <th style="width: 10%;">Timestamp</th>
                <th style="width: 5%;">Level</th>
                <th style="width: 10%;">Event</th>
                <th style="width: 65%;">Message</th>
            </tr>
        </thead>
        <tbody id="logs-table-body">
        </tbody>
    </table>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
</body>

<script>
    window.addEventListener("DOMContentLoaded", function () {
        getInitialLogs();
        addEventListeners()
    });

    function hideMe(el) {
        el.style.display = 'none';
    }

    function addEventListeners() {
        var provider_buttons = document.getElementsByClassName("provider-buttons")

        for (var i = 0; i < provider_buttons.length; i++) {
            provider_buttons[i].addEventListener('click', (event) => {
                var button = event.target
                var table = document.getElementById("logs-table-body");
                table.innerHTML = ""
                getLogs(button.value)
            }, false);
        }
    }

    function getInitialLogs() {
        fetch("/project-logs", {
            method: 'GET',
        })
            .then((data) => {
                return data.text()
            })
            .then((response) => {
                // createLogsTable(response)
            })
            .catch(function (error) {
                swal("Provider not available", "Could not get logs: " + error, "error")
            })
    }

    let logsSocket = null

    window.addEventListener('beforeunload', () => {
        console.log("Closing WS")
        logsSocket.onclose = function () { }
        logsSocket.close();
    });

    function getLogs(url) {

        if (logsSocket != null) {
            logsSocket.onclose = function () { }
            console.log("Closing WS")
            logsSocket.close()
        }

        // Get the hostname and port from the browser
        const hostname = window.location.hostname;
        const port = window.location.port;
        logsSocket = new WebSocket("ws://{{.GadsHostAddress}}:{{.GadsPort}}/logs-ws?collection=" + url);

        // On each message over the websocket update the device selection table
        logsSocket.onmessage = function (event) {
            var json = JSON.parse(event.data)
            createLogsTable(json)
        };
    }

    function createLogsTable(json) {
        console.log(json)
        var table = document.getElementById("logs-table-body");

        for (let i = json.length - 1; i >= 0; i--) {
            if (json[i].message == "") {
                continue
            }

            var tr = document.createElement('tr');
            tr.id = "table-row"

            var td2 = document.createElement('td');
            var td3 = document.createElement('td');
            var td4 = document.createElement('td');
            var td5 = document.createElement('td');

            const date = moment(json[i].timestamp);

            // Format the date as per your desired format
            const formattedDate = date.format("DD-MM-YYYY HH:mm:ss.SSS");

            var timestamp = document.createTextNode(formattedDate);
            var level = document.createTextNode(json[i].level);
            var event = document.createTextNode(json[i].eventname);
            var message = document.createTextNode(json[i].message);

            td2.appendChild(timestamp);
            td3.appendChild(level);
            td4.appendChild(event);
            td5.appendChild(message);
            tr.appendChild(td2);
            tr.appendChild(td3);
            tr.appendChild(td4);
            tr.appendChild(td5);

            if (level.textContent === "error") {
                tr.style.backgroundColor = "#ff8330"
            } else if (level.textContent === "info") {
                tr.style.backgroundColor = "#b7eb34"
            } else if (level.textContent === "fatal") {
                tr.style.backgroundColor = "#ff8330"
            } else if (level.textContent === "debug") {
                tr.style.backgroundColor = "#ffe330"
            } else if (level.textContent === "warning") {
                tr.style.backgroundColor = "#ff8330"
            }

            table.insertBefore(tr, table.firstChild)
        }
    }
</script>

</html>