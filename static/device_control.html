<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Device Control</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/jquery.fancytree/2.38.1/skin-lion/ui.fancytree.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<style>
    #image-stream,
    #actions-canvas {
        margin-top: 20px;
        margin-left: 10px;
    }

    #container-div {
        height: 100%;
        width: 100%;
        display: flex;
    }

    #actions-div,
    #source-div,
    #stream-div,
    #element-div,
    #device-buttons {
        display: inline-block;
        *display: inline;
        zoom: 1;
        vertical-align: top;
        visibility: hidden;
    }

    #actions-canvas {
        border: 1px solid #000;
    }

    #actions-div {
        width: 25%;
        max-width: 650px;
    }

    #source-div {
        margin-left: 20px;
        /* border: 1px solid #000; */
    }

    #device-info-table,
    #element-info-table,
    th,
    td {
        border-bottom: 1px solid black;
        border-collapse: collapse;
    }

    td {
        text-align: center;
    }

    #loading {
        visibility: hidden;
        position: fixed;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        text-align: center;
        opacity: 0.7;
        background-color: #fff;
        z-index: 99;
    }

    #loading-image {
        position: relative;
    }

    #small-loader {
        visibility: hidden;
        position: fixed;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        text-align: center;
        opacity: 0.7;
        background-color: #fff;
        z-index: 99;
    }

    #small-loader-image {
        position: relative;
    }

    #app-source {
        width: 100%;
        margin-left: 10px;
    }

    #app-source {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    ul.fancytree-container {
        border: none;
    }

    span.fancytree-title {
        font-size: 18px;
    }

    .device-button {
        background-color: DodgerBlue;
        border: none;
        color: white;
        padding: 12px 16px;
        font-size: 16px;
        cursor: pointer;
        width: 45px;
        height: 45px;
        display: inline-block;
        display: grid;
        margin: 5px;
    }

    /* Darker background on mouse-over */
    .device-button:hover {
        background-color: RoyalBlue;
    }

    #device-buttons {
        padding-top: 20px;
    }

    .modal {
        display: none;
        z-index: 1;
        position: fixed;
        width: 100%;
        height: 100%;
        background-color: rgb(0, 0, 0);
        background-color: rgba(0, 0, 0, 0.4);
        overflow: inherit;
        overflow-y: inherit;
        text-align: center;
        word-wrap: break-word;
    }

    .ripple {
        width: 10px;
        height: 10px;
        position: fixed;
        border-radius: 50%;
        border: 1px solid #ffffff;
        pointer-events: none;
    }

    @keyframes ripple-effect {
        to {
            transform: scale(5);
            opacity: 0;
        }
    }
</style>

<body>
    <div id="loading">
        <img id="loading-image" src="/static/images/loader.gif">
    </div>
    <div class="modal fade" id="type-text-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div>
            <input id="type-text-input" type="text"></input>
            <button id="submit-type-text" type="button">Type</button>
        </div>
    </div>
    <div class="topnav">
        <link href="/static/css/top_navigation_style.css" rel="stylesheet">
        <a href="/">Home</a>
        <a href="configuration.html">Project configuration</a>
        <a href="device-containers.html">Device containers</a>
        <a href="project-logs.html">Project logs</a>
        <a class="active" href="device-control.html">Device Control</a>
        <a href="swagger/index.html" target="_blank">Swagger</a>
    </div>
    <div>Please select a device
        <select id="device-dropdown" name="devices" onchange="updateDeviceInfo()"></select>
    </div>
    <div id="container-div">
        <div id="stream-div" style="position: relative;">
            <div id="small-loader" style="visibility: hidden;position: absolute;">
                <img id="small-loader-image" src="/static/images/small-loader.gif">
            </div>
            <canvas id="actions-canvas" style="position: absolute;"></canvas>
            <img id="image-stream"></img>
        </div>
        <div id="device-buttons" style="margin-left:5px;width:55px;text-align: center;">
            <button class="device-button" id="home-button" title="Go to home screen"><i class="fa fa-home"></i></button>
            <button class="device-button" id="unlock-button" title="Unlock device"><i class="fa fa-unlock"></i></button>
            <button class="device-button" id="lock-button" title="Lock device"><i class="fa fa-lock"></i></button>
            <button class="device-button" id="type-button" title="Type text in active element"><i
                    class="fa fa-pencil"></i></button>
            <button class="device-button" id="clear-text-button" title="Clear text in active element"><i
                    class="fa fa-eraser"></i></button>
        </div>
        <div id="actions-div" style="border: 1px solid #000;padding: 10px;">
            <h3>Device Config Info</h3>
            <table id="device-info-table" style="width:100%"></table>
            <div>
                <h4>Installed apps</h4>
                <select id="installed-apps-dropdown" name="installed-apps"></select>
                <button id="uninstall-app" onclick="uninstallApp()">Uninstall app</button>
            </div>
            <div>
                <h4>Installable apps</h4>
                <select id="installable-apps-dropdown" name="installable-apps"></select>
                <button id="install-app" onclick="installApp()">Install app</button>
            </div>
            <div>
                <h4>Get app source</h4>
                <button id="get-app-source" onclick="getAppSource()">Get app source</button>
            </div>
            <div>
                <h4>Element interactions</h4>
                <select id="element-query-type">
                    <option value="xpath" selected>Xpath</option>
                    <option value="class chain">Class chain</option>
                    <option value="accessibility id">Accessibility ID</option>
                    <option value="predicate string">Predicate string</option>
                </select>
                <input id="element-query" type="text"></input>
                <button id="query-elements" onclick="createElementsDropdown()">
                    Query elements
                </button></br>
                <select id="found-elements-dropdown" onchange="drawRectangle()"
                    style="visibility: hidden;"></select></br>
                <button id="tap-element" onclick="tapElement()">
                    Tap element
                </button>
                <button onclick="clearCanvas()">Clear canvas</button>
            </div>
        </div>
        <div id="source-div" style="border: 1px solid #000; padding: 10px;">
            <div style="width: 600px;height: 1000px;overflow: auto;">
                <h3>App source</h3>
                <div id="app-source"></div>
            </div>
        </div>
        <div id="element-div" style="border: 1px solid #000; padding: 10px;margin-left: 5px;">
            <div style="width: 600px;height: 600px;overflow: auto;">
                <h3>Selected element</h3>
                <div id="selected-element">Select an element from the app source
                    <table id="element-info-table" style="width:100%; visibility: hidden;">
                        <tr>
                            <th style="width: 30%;">Attribute</th>
                            <td>Value</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.fancytree/2.38.1/jquery.fancytree-all.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/jquery.fancytree/2.38.1/jquery.fancytree-all-deps.min.js"></script>
</body>

<script>
    window.addEventListener("DOMContentLoaded", function () {
        getDeviceControlInfo();
    });

    function createElementInfoTable() {
        let selected_device_text = $("#device-dropdown option:selected").text()
        let table_element = $("#element-info-table")

        if (selected_device_text.includes("iOS")) {
            table_element.empty()
            table_element.append('<tr><th>type</th><td id="element-type"></td></tr>')
            table_element.append('<tr><th>name</th><td id="element-name"></td></tr>')
            table_element.append('<tr><th>label</th><td id="element-label"></td></tr>')
            table_element.append('<tr><th>visible</th><td id="element-visible"></td></tr>')
            table_element.append('<tr><th>enabled</th><td id="element-enabled"></td></tr>')
            table_element.append('<tr><th>value</th><td id="element-value"></td></tr>')
            table_element.append('<tr><th>x</th><td id="element-x"></td></tr>')
            table_element.append('<tr><th>y</th><td id="element-y"></td></tr>')
            table_element.append('<tr><th>width</th><td id="element-width"></td></tr>')
            table_element.append('<tr><th>height</th><td id="element-height"></td></tr>')
        } else {
            table_element.empty()
            table_element.append('<tr><th>index</th><td id="element-index"></td></tr>')
            table_element.append('<tr><th>resource-id</th><td id="element-resourceid"></td></tr>')
            table_element.append('<tr><th>package</th><td id="element-package"></td></tr>')
            table_element.append('<tr><th>class</th><td id="element-class"></td></tr>')
            table_element.append('<tr><th>text</th><td id="element-text"></td></tr>')
            table_element.append('<tr><th>checkable</th><td id="element-checkable"></td></tr>')
            table_element.append('<tr><th>checked</th><td id="element-checked"></td></tr>')
            table_element.append('<tr><th>clickable</th><td id="element-clickable"></td></tr>')
            table_element.append('<tr><th>enabled</th><td id="element-enabled"></td></tr>')
            table_element.append('<tr><th>focusable</th><td id="element-focusable"></td></tr>')
            table_element.append('<tr><th>focused</th><td id="element-focused"></td></tr>')
            table_element.append('<tr><th>long-clickable</th><td id="element-long-clickable"></td></tr>')
            table_element.append('<tr><th>password</th><td id="element-password"></td></tr>')
            table_element.append('<tr><th>scrollable</th><td id="element-scrollable"></td></tr>')
            table_element.append('<tr><th>selected</th><td id="element-selected"></td></tr>')
            table_element.append('<tr><th>bounds</th><td id="element-bounds"></td></tr>')
            table_element.append('<tr><th>displayed</th><td id="element-displayed"></td></tr>')
        }
    }

    document.getElementById("home-button").addEventListener('click', () => {
        let selected_device_text = $("#device-dropdown option:selected").text()
        var url;
        var json = "{}"

        // if the device is android use press_keycode endpoint and send keycode 3 which is for the Home button
        // if device is iOS send empty json
        if (selected_device_text.includes("android")) {
            url = "http://127.0.0.1:" + $('#appium-port').text() + "/wd/hub/session/" + $("#appium-session-id").text() + "/appium/device/press_keycode"
            json = JSON.stringify({ "keycode": 3 })
        } else if (selected_device_text.includes("iOS")) {
            let wda_url = $("#wda-url").text()
            url = wda_url + "/wda/homescreen"
        } else {
            return
        }

        fetch(url, {
            method: 'POST',
            body: json,
            headers: {
                'Content-type': 'application/json'
            }
        })
            .then(() => {
            })
            .catch(function (error) {
                alert("Could not access iOS device homescreen endpoint. Error: " + error)
            })
    })

    document.getElementById("unlock-button").addEventListener('click', () => {
        let selected_device_text = $("#device-dropdown option:selected").text()
        var url;

        if (selected_device_text.includes("android")) {
            url = "http://127.0.0.1:" + $('#appium-port').text() + "/wd/hub/session/" + $("#appium-session-id").text() + "/appium/device/unlock"
        } else if (selected_device_text.includes("iOS")) {
            let wda_url = $("#wda-url").text()
            let wda_session_id = $("#wda-session-id").text()
            url = wda_url + "/session/" + wda_session_id + "/wda/unlock"
        } else {
            return
        }

        fetch(url, {
            method: 'POST'
        })
    })

    document.getElementById("lock-button").addEventListener('click', () => {
        let selected_device_text = $("#device-dropdown option:selected").text()
        var url;

        if (selected_device_text.includes("android")) {
            url = "http://127.0.0.1:" + $('#appium-port').text() + "/wd/hub/session/" + $("#appium-session-id").text() + "/appium/device/lock"
        } else if (selected_device_text.includes("ios")) {
            let wda_url = $("#wda-url").text()
            let wda_session_id = $("#wda-session-id").text()
            url = wda_url + "/session/" + wda_session_id + "/wda/lock"
        } else {
            return
        }

        fetch(url, {
            method: 'POST'
        })
    })

    document.getElementById("submit-type-text").addEventListener('click', () => {
        typeText()
    })

    document.getElementById("type-button").addEventListener('click', () => {
        var modal = document.getElementById("type-text-modal")
        modal.style.display = "block"

        /* Close the modal if you click anywhere outside the modal */
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    })

    document.getElementById("clear-text-button").addEventListener('click', () => {
        clearText()
    })

    function getDeviceControlInfo() {
        $.ajax({
            async: false,
            type: "GET",
            url: "/devices/device-control",
            success: function (data) {
                createDeviceDropdown(data)
            },
            error: function (data) {
                alert("Broken data");
            }
        });
    }

    async function typeText() {
        let selected_device_text = $("#device-dropdown option:selected").text()
        var active_element_url;
        var element_value_url;
        var wda_url;
        var wda_session_id;

        if (selected_device_text.includes("android")) {
            active_element_url = "http://127.0.0.1:" + $('#appium-port').text() + "/wd/hub/session/" + $("#appium-session-id").text() + "/element/active"
        } else if (selected_device_text.includes("iOS")) {
            wda_url = $("#wda-url").text()
            wda_session_id = $("#wda-session-id").text()
            active_element_url = wda_url + "/session/" + wda_session_id + "/element/active"
        } else {
            return
        }

        const control_response = await fetch(active_element_url).then(response => {
            if (response.ok) {
                return response.json()
            } else {
                return null
            }
        })

        var element_id = control_response.value.ELEMENT
        if (selected_device_text.includes("android")) {
            element_value_url = "http://127.0.0.1:" + $('#appium-port').text() + "/wd/hub/session/" + $("#appium-session-id").text() + "/element/" + element_id + "/value"
        } else {
            element_value_url = wda_url + "/session/" + wda_session_id + "/element/" + element_id + "/value"
        }

        if (control_response != null) {
            if (element_id != "") {
                var text_input = $("#type-text-input").val();
                await fetch(element_value_url, {
                    method: 'POST',
                    headers: {
                        'Content-type': 'application/json'
                    },
                    body: JSON.stringify({ "text": text_input })
                })
            }
        }
    }

    async function clearText() {
        let selected_device_text = $("#device-dropdown option:selected").text()
        var active_element_url;
        var element_clear_url;
        var wda_url;
        var wda_session_id;

        if (selected_device_text.includes("android")) {
            active_element_url = "http://127.0.0.1:" + $('#appium-port').text() + "/wd/hub/session/" + $("#appium-session-id").text() + "/element/active"
        } else if (selected_device_text.includes("iOS")) {
            wda_url = $("#wda-url").text()
            wda_session_id = $("#wda-session-id").text()
            active_element_url = wda_url + "/session/" + wda_session_id + "/element/active"
        } else {
            return
        }

        const control_response = await fetch(active_element_url).then(response => {
            if (response.ok) {
                return response.json()
            } else {
                return null
            }
        })

        var element_id = control_response.value.ELEMENT
        if (selected_device_text.includes("android")) {
            element_clear_url = "http://127.0.0.1:" + $('#appium-port').text() + "/wd/hub/session/" + $("#appium-session-id").text() + "/element/" + element_id + "/clear"
        } else {
            element_clear_url = wda_url + "/session/" + wda_session_id + "/element/" + element_id + "/clear"
        }

        if (control_response != null) {
            var element_id = control_response.value.ELEMENT
            if (element_id != "") {
                await fetch(element_clear_url, {
                    method: 'POST'
                })
            }
        }
    }

    async function updateDeviceInfo() {
        createElementInfoTable();
        $('#loading').css("visibility", "visible")
        const control_response = await fetch("/devices/device-control").then(response => {
            if (response.ok) {
                return response.json()
            } else {
                return null
            }
        }).catch(function (error) {
            alert("Could not get device control info" + error)
        })

        if (control_response != null) {
            let device_udid = $("#device-dropdown").val();
            let selected_device_text = $("#device-dropdown option:selected").text()

            if (selected_device_text.includes("iOS")) {
                let wda_url;
                for (let i = 0; i < control_response["ios-devices-info"].length; i++) {
                    if (control_response["ios-devices-info"][i].deviceConfig.device_udid === device_udid) {
                        wda_url = control_response["ios-devices-info"][i].deviceConfig.wda_url
                    }
                }
                await fetch(wda_url + "/status").then(response => {
                    if (response.ok) {
                        updateIOSDeviceConfigTable(control_response)
                        createIOSAppsDropdown(control_response)
                        createInstallableAppsDropdown(control_response)
                        changeStream(control_response)
                        checkWDASession()
                        updateStreamSize()
                        $('#actions-div').css("visibility", "visible")
                        $('#stream-div').css("visibility", "visible")
                        $('#source-div').css("visibility", "visible")
                        $('#element-div').css("visibility", "visible")
                        $('.device-button').css("visibility", "visible")
                        $('#loading').css("visibility", "hidden")
                    } else {
                        alert("WDA not available, can't load device.")
                    }
                }).catch(function (error) {
                    alert("Could not load device:" + error)
                })
            } else if (selected_device_text.includes("android")) {
                for (let i = 0; i < control_response["android-devices-info"].length; i++) {
                    if (control_response["android-devices-info"][i].deviceConfig.device_udid === device_udid) {
                        updateAndroidDeviceConfigTable(control_response)
                        createInstallableAppsDropdown(control_response)
                        changeStream(control_response)
                        updateStreamSize()
                        checkAppiumSession()
                        $('#actions-div').css("visibility", "visible")
                        $('#stream-div').css("visibility", "visible")
                        $('#source-div').css("visibility", "visible")
                        $('.device-button').css("visibility", "visible")
                    }
                }
            } else {
                alert("What the hell is that device container?")
            }
        } else {
            alert("Device control response is not okay")
        }
    }

    async function checkAppiumSession() {
        let appium_port = $("#appium-port").text()
        let appium_session_id = $("#appium-session-id")
        let json = ""

        // build the json to create a session
        json = JSON.stringify({
            "capabilities": {
                "alwaysMatch": {
                    "appium:automationName": "UiAutomator2",
                    "platformName": "Android",
                    "appium:ensureWebviewsHavePages": true,
                    "appium:nativeWebScreenshot": true,
                    "appium:newCommandTimeout": 0,
                    "appium:connectHardwareKeyboard": true
                },
                "firstMatch": [
                    {}
                ]
            },
            "desiredCapabilities": {
                "appium:automationName": "UiAutomator2",
                "platformName": "Android",
                "appium:ensureWebviewsHavePages": true,
                "appium:nativeWebScreenshot": true,
                "appium:newCommandTimeout": 0,
                "appium:connectHardwareKeyboard": true
            }
        })

        // show a loading while creating session
        //$('#loading').css("visibility", "visible");

        let sessions_url = "http://127.0.0.1:" + appium_port + "/wd/hub/sessions"
        let session_url = "http://127.0.0.1:" + appium_port + "/wd/hub/session"
        const sessions_response = await fetch(sessions_url).then(response => {
            return response.json()
        })
            .catch(function (error) {
                alert("Could not get Appium sessions" + error)
            })

        if (sessions_response.value.length === 0) {
            const session_response = await fetch(session_url, {
                method: 'POST',
                body: json,
                headers: {
                    'Content-type': 'application/json'
                }
            })
                .then(response => {
                    return response.json()
                })
                .catch(function (error) {
                    alert("Could not create Appium session" + error)
                })
            appium_session_id.text(session_response.value.sessionId)
        } else if (sessions_response.value[0].id === null) {
            const session_response = await fetch(session_url, {
                method: 'POST',
                body: json,
                headers: {
                    'Content-type': 'application/json'
                }
            })
                .then(response => {
                    return response.json()
                })
                .catch(function (error) {
                    alert("Could not create Appium session" + error)
                })
            appium_session_id.text(session_response.value.sessionId)
        } else {
            appium_session_id.text(sessions_response.value[0].id)
        }
        $('#loading').css("visibility", "hidden")
    }

    function updateIOSDeviceConfigTable(response) {
        // Get the device UDID from the value of the selected option
        var device_udid = $("#device-dropdown").val();
        let table_element = $("#device-info-table")
        table_element.empty()

        //var response = JSON.parse(json)
        for (let i = 0; i < response["ios-devices-info"].length; i++) {
            if (response["ios-devices-info"][i].deviceConfig.device_udid === device_udid) {
                table_element.append('<tr><th>Device Model:</th><td>' + response["ios-devices-info"][i].deviceConfig.device_model + '</td></tr>')
                table_element.append('<tr><th>Device Name:</th><td>' + response["ios-devices-info"][i].deviceConfig.device_name + '</td></tr>')
                table_element.append('<tr><th>Device OS version:</th><td>' + response["ios-devices-info"][i].deviceConfig.device_os_version + '</td></tr>')
                table_element.append('<tr><th>Device UDID:</th><td>' + response["ios-devices-info"][i].deviceConfig.device_udid + '</td></tr>')
                table_element.append('<tr><th>Appium Port:</th><td id="appium-port">' + response["ios-devices-info"][i].deviceConfig.appium_port + '</td></tr>')
                table_element.append('<tr><th>WDA Port:</th><td>' + response["ios-devices-info"][i].deviceConfig.wda_port + '</td></tr>')
                table_element.append('<tr><th>WDA Mjpeg Port:</th><td>' + response["ios-devices-info"][i].deviceConfig.wda_mjpeg_port + '</td></tr>')
                table_element.append('<tr><th>WDA URL:</th><td id="wda-url">' + response["ios-devices-info"][i].deviceConfig.wda_url + '</td></tr>')
                table_element.append('<tr><th>WDA Stream URL:</th><td>' + response["ios-devices-info"][i].deviceConfig.wda_stream_url + '</td></tr>')
                table_element.append('<tr><th>Device screen size:</th><td id="device-size">' + response["ios-devices-info"][i].deviceConfig.viewport_size + '</td></tr>')
                table_element.append('<tr><th>WDA session ID:</th><td id="wda-session-id">No session</td></tr>')
            }
        }
        return response
    }

    function updateAndroidDeviceConfigTable(response) {
        // Get the device UDID from the value of the selected option
        var device_udid = $("#device-dropdown").val();
        let table_element = $("#device-info-table")
        table_element.empty()

        //var response = JSON.parse(json)
        for (let i = 0; i < response["android-devices-info"].length; i++) {
            if (response["android-devices-info"][i].deviceConfig.device_udid === device_udid) {
                table_element.append('<tr><th>Device Name:</th><td>' + response["android-devices-info"][i].deviceConfig.device_name + '</td></tr>')
                table_element.append('<tr><th>Device OS version:</th><td>' + response["android-devices-info"][i].deviceConfig.device_os_version + '</td></tr>')
                table_element.append('<tr><th>Device UDID:</th><td>' + response["android-devices-info"][i].deviceConfig.device_udid + '</td></tr>')
                table_element.append('<tr><th>Appium Port:</th><td id="appium-port">' + response["android-devices-info"][i].deviceConfig.appium_port + '</td></tr>')
                table_element.append('<tr><th>Device stream size:</th><td id="device-size">' + response["android-devices-info"][i].deviceConfig.stream_size + '</td></tr>')
                table_element.append('<tr><th>Stream Port:</th><td id="stream-port">' + response["android-devices-info"][i].deviceConfig.stream_port + '</td></tr>')
                table_element.append('<tr><th>Appium session ID:</th><td id="appium-session-id">No session</td></tr>')
            }
        }
        return response
    }

    function createDeviceDropdown(data) {
        let device_dropdown = $('#device-dropdown');

        device_dropdown.empty();

        device_dropdown.append('<option>Choose device</option>');

        device_dropdown.prop('selectedIndex', 0);
        var response = JSON.parse(data)
        for (let i = 0; i < response["running-containers"].length; i++) {
            var match = response["running-containers"][i].match(/[^_]*$/)
            device_dropdown.append($('<option></option>').attr('value', match[0]).text(response["running-containers"][i]));
        }
    }

    function updateStreamSize() {
        // Set max height of 850 pixels for the stream element
        let maxHeight = 850

        // Get the actual device dimensions
        let deviceSize = $("#device-size").text()
        let dimensions = deviceSize.split('x');

        let stream_width = ""
        let stream_height = ""

        // if the height of the device is less than the max height of the stream element
        // just set the stream size to the original device size
        if (dimensions[1] < maxHeight) {
            stream_width = dimensions[0] + "px"
            stream_height = dimensions[1] + "px"
        } else {
            // else if the height of the device is more than the max height of the stream element
            // get the actual device screen ratio
            // get android navigation bar size from http://127.0.0.1:4881/wd/hub/session/b06a2da9-e342-4b81-871d-1b00b391ba57/appium/device/system_bars
            //let device_ratio = dimensions[0] / (parseInt(dimensions[1], 10) + 122)
            let device_ratio = dimensions[0] / dimensions[1]

            // Set the stream height to the max height
            stream_height = maxHeight
            // set the stream width based on the max height and device ratio
            stream_width = (maxHeight * device_ratio).toFixed(0)
        }


        $("#image-stream").attr('width', stream_width).attr('height', stream_height)
        $("#actions-canvas").attr('width', stream_width).attr('height', stream_height)
    }

    function createIOSAppsDropdown(response) {
        var device_udid = $("#device-dropdown").val();

        let apps_dropdown = $('#installed-apps-dropdown');
        apps_dropdown.empty();
        apps_dropdown.prop('selectedIndex', 0);

        //var response = JSON.parse(data)
        for (let i = 0; i < response["ios-devices-info"].length; i++) {
            if (response["ios-devices-info"][i].deviceConfig.device_udid === device_udid) {
                for (let x = 0; x < response["ios-devices-info"][i].installedAppsBundleIDs.length; x++) {
                    apps_dropdown.append($('<option></option>').attr('value', response["ios-devices-info"][i].installedAppsBundleIDs[x]).text(response["ios-devices-info"][i].installedAppsBundleIDs[x]));
                }
            }
        }
        return response
    }

    function createInstallableAppsDropdown(response) {
        // Get the device UDID from the value of the selected option
        var device_udid = $("#device-dropdown").val();

        let apps_dropdown = $('#installable-apps-dropdown');

        let container_name = $("#device-dropdown option:selected").text()

        apps_dropdown.empty();
        apps_dropdown.prop('selectedIndex', 0);

        //var response = JSON.parse(data)
        for (let i = 0; i < response["installable-apps"].length; i++) {
            if (container_name.includes("iOSDevice") && response["installable-apps"][i].includes(".ipa") || response["installable-apps"][i].includes(".app")) {
                apps_dropdown.append($('<option></option>').attr('value', response["installable-apps"][i]).text(response["installable-apps"][i]));
            } else if (container_name.includes("androidDevice") && response["installable-apps"][i].includes(".apk")) {
                apps_dropdown.append($('<option></option>').attr('value', response["installable-apps"][i]).text(response["installable-apps"][i]));
            }
        }
        return response
    }

    function changeStream(response) {
        var device_udid = $("#device-dropdown").val();
        let image_stream = $('#image-stream')
        let selected_device_text = $("#device-dropdown option:selected").text()

        if (selected_device_text.includes("iOS")) {
            for (let i = 0; i < response["ios-devices-info"].length; i++) {
                if (response["ios-devices-info"][i].deviceConfig.device_udid === device_udid) {
                    image_stream.attr('src', response["ios-devices-info"][i].deviceConfig.wda_stream_url)
                }
            }
        } else if (selected_device_text.includes("android")) {
            image_stream.attr('src', "http://127.0.0.1:" + $('#stream-port').text())
        }
    }

    function uninstallApp() {
        var bundle_id = $('#installed-apps-dropdown').val();
        var device_udid = $("#device-dropdown").val();

        $.ajax({
            contentType: 'application/json',
            async: true,
            type: "POST",
            data: JSON.stringify({ "bundle_id": bundle_id }),
            url: "/ios-devices/" + device_udid + "/uninstall-app",
            success: function (data) {
                swal("Info message", "Successfully uninstalled app with bundleID:'" + bundle_id + "'", "success")
                    .then(() => {
                        location.reload();
                    });
            },
            error: function (data) {
                swal("Uninstall app error", $.parseJSON(data.responseText).error_message, "error")
            }
        });
    }

    function installApp() {
        var ipa_name = $('#installable-apps-dropdown').val();
        var device_udid = $("#device-dropdown").val();

        $('#loading').css("visibility", "visible");

        $.ajax({
            contentType: 'application/json',
            async: true,
            type: "POST",
            data: JSON.stringify({ "ipa_name": ipa_name }),
            url: "/ios-devices/" + device_udid + "/install-app",
            success: function (data) {
                $('#loading').css("visibility", "hidden");
                swal("Install app", "Successfully installed app :'" + ipa_name + "'", "success")
                    .then(() => {
                        location.reload();
                    });
            },
            error: function (data) {
                $('#loading').css("visibility", "hidden");
                swal($.parseJSON(data.responseText).event, $.parseJSON(data.responseText).error_message, "error")
            }
        });
    }

    // check if a wda session exists and connect to it or create a new one
    function checkWDASession() {
        let wda_url = $("#wda-url").text()
        let wda_session_el = $("#wda-session-id")

        // if there is no session id from the /status endpoint create a new session
        // else just update the session id in the table with the existing session
        $.ajax({
            type: "GET",
            url: wda_url + "/status",
            success: function (data) {
                if (data.sessionId === null) {
                    createWDASession()
                } else {
                    wda_session_el.text(data.sessionId)
                }
            },
            error: function (data) {
                console.log("could not get session")
            }
        });
    }

    // create a wda session to the iOS device if no session exists
    function createWDASession() {
        let wda_url = $("#wda-url").text()
        let wda_session = $("#wda-session-id")
        let json = ""

        // build the json to create a session
        json = JSON.stringify({
            "capabilities": {
                "firstMatch": [
                    {
                        "arguments": [],
                        "environment": {},
                        "eventloopIdleDelaySec": 0,
                        "shouldWaitForQuiescence": true,
                        "shouldUseTestManagerForVisibilityDetection": false,
                        "maxTypingFrequency": 60,
                        "shouldUseSingletonTestManager": true,
                        "shouldTerminateApp": true,
                        "forceAppLaunch": true,
                        "useNativeCachingStrategy": true,
                        "forceSimulatorSoftwareKeyboardPresence": false
                    }
                ],
                "alwaysMatch": {}
            }
        })

        // show a loading while creating session
        $('#loading').css("visibility", "visible");

        // create the new session
        // on success update the wda session id in the table
        $.ajax({
            type: "POST",
            url: wda_url + "/session",
            data: json,
            success: function (data) {
                $('#loading').css("visibility", "hidden");
                wda_session.text(data.sessionId)
            },
            error: function (data) {
                $('#loading').css("visibility", "hidden");
                alert("Could not start session for bundleID:" + bundle_id)
            }
        });
    }

    //
    function getAppSource() {
        let selected_device_text = $("#device-dropdown option:selected").text()
        var url;
        var wda_url;
        var wda_session_id;

        if (selected_device_text.includes("android")) {
            url = "http://127.0.0.1:" + $('#appium-port').text() + "/wd/hub/session/" + $("#appium-session-id").text() + "/source"
        } else if (selected_device_text.includes("iOS")) {
            wda_url = $("#wda-url").text()
            wda_session_id = $("#wda-session-id").text()
            url = wda_url + "/session/" + wda_session_id + "/source"
        } else {
            return
        }

        let app_source = $("#app-source")
        parser = new DOMParser();

        $('#loading').css("visibility", "visible");

        $.ajax({
            async: true,
            type: "GET",
            url: url,
            success: function (data) {
                $('#loading').css("visibility", "hidden");

                // parse the xml doc from the Appium response xml
                xmlDoc = parser.parseFromString(data.value, "text/xml");

                // parse the xml response into a json format accepted by jstree
                if (selected_device_text.includes("android")) {
                    var jstree_json = androidGenerateJSONForTreeFromXML(xmlDoc.documentElement)
                } else {
                    var jstree_json = iOSGenerateJSONForTreeFromXML(xmlDoc.documentElement)
                }

                // If the tree already exists and has children - reload it with the new data
                // If the tree doesn't exist or doesn't have children - initialize it for the first time with the needed options
                if (app_source.children().length > 0) {
                    $.ui.fancytree.getTree().reload(JSON.parse(jstree_json));
                } else {
                    app_source.fancytree({
                        'source': [
                            JSON.parse(jstree_json)
                        ],
                        activate: function (event, data) {
                            var element_values = JSON.parse(data.node.key.replaceAll("'", "\""))
                            showElementInfo(element_values)
                            drawRectangleForTree(element_values)
                        }
                    });
                }
            },
            error: function () {
                $('#loading').css("visibility", "hidden");
                app_source.text("Couldn't get app source")
            }
        });
    }

    // read the Appium xml for an iOS device and transform it into a json accepted by fancytree
    function iOSGenerateJSONForTreeFromXML(node) {
        if (node.nodeType != 1) return "";

        // Get all the data from the xml doc returned by Appium
        var elemType = node.getAttribute('type')
        var elemX = node.getAttribute('x')
        var elemY = node.getAttribute('y')
        var elemWidth = node.getAttribute('width')
        var elemHeight = node.getAttribute('height')
        var elemName = node.getAttribute('name')
        var elemLabel = node.getAttribute('label')
        var elemVisible = node.getAttribute('visible')
        var elemEnabled = node.getAttribute('enabled')
        var elemValue = node.getAttribute('value')

        // this is not a valid json but this is the only way I could find to embed it inside another json (bad developer)
        // it is reworked later into valid json that can be parsed
        value_json = `{'type':'` + elemType + `',` +
            `'x':'` + elemX + `',` +
            `'y':'` + elemY + `',` +
            `'width':'` + elemWidth + `',` +
            `'height':'` + elemHeight + `',` +
            `'name':'` + elemName + `',` +
            `'label':'` + elemLabel + `',` +
            `'visible':'` + elemVisible + `',` +
            `'enabled':'` + elemEnabled + `',` +
            `'value':'` + elemValue + `'}`

        // for each node open with an object
        // the key is the "json" (quotes intended) that will we will read later upon clicking a node in the tree
        // no icons since its not a folder/file structure
        // no lazy loading - the whole tree is loaded
        // no default active nodes in the tree
        // title is the element type
        var mainJson = `{"key":"` + value_json + `", "icon": false, "lazy": false, "active": false,"title":"` + node.nodeName + `"`
        var jsonForChildNodes = "";

        // if the node has children open the children array
        if (node.childNodes.length > 0) {
            mainJson += `, "children":[`
        }
        for (var i = 0; i < node.childNodes.length; i++) {
            // for each child of the main node generate deeper json objects
            jsonForChildNodes += iOSGenerateJSONForTreeFromXML(node.childNodes[i]);
        }
        if (jsonForChildNodes) {
            // close the children array
            mainJson += jsonForChildNodes + `]`
        }
        // close the json object
        mainJson += `}`

        // cus I am a bad developer I couldn't think of the proper way to 
        // build the json with all needed commas so I invented this solution
        // to add the missing commas to make the json valid xD
        mainJson = mainJson.replaceAll("}{", "},{")
        return mainJson;
    }

    // read the Appium xml for an Android device and transform it into a json accepted by fancytree
    function androidGenerateJSONForTreeFromXML(node) {
        if (node.nodeType != 1) return "";

        // Get all the data from the xml doc returned by Appium
        var index = node.getAttribute('index')
        var package = node.getAttribute('package')
        var element_class = node.getAttribute('class')
        var text = node.getAttribute('text')
        var checkable = node.getAttribute('checkable')
        var checked = node.getAttribute('checked')
        var clickable = node.getAttribute('clickable')
        var enabled = node.getAttribute('enabled')
        var focusable = node.getAttribute('focusable')
        var focused = node.getAttribute('focused')
        var long_clickable = node.getAttribute('long-clickable')
        var password = node.getAttribute('password')
        var scrollable = node.getAttribute('scrollable')
        var selected = node.getAttribute('false')
        var bounds = node.getAttribute('bounds')
        var displayed = node.getAttribute('displayed')
        var resource_id = node.getAttribute('resource-id')

        // this is not a valid json but this is the only way I could find to embed it inside another json (bad developer)
        // it is reworked later into valid json that can be parsed
        value_json = `{'index':'` + index + `',` +
            `'package':'` + package + `',` +
            `'class':'` + element_class + `',` +
            `'text':'` + text + `',` +
            `'checkable':'` + checkable + `',` +
            `'checked':'` + checked + `',` +
            `'clickable':'` + clickable + `',` +
            `'enabled':'` + enabled + `',` +
            `'focusable':'` + focusable + `',` +
            `'focused':'` + focused + `',` +
            `'longclickable':'` + long_clickable + `',` +
            `'password':'` + password + `',` +
            `'scrollable':'` + scrollable + `',` +
            `'selected':'` + selected + `',` +
            `'bounds':'` + bounds + `',` +
            `'resourceid':'` + resource_id + `',` +
            `'displayed':'` + displayed + `'}`

        // for each node open with an object
        // the key is the "json" (quotes intended) that will we will read later upon clicking a node in the tree
        // no icons since its not a folder/file structure
        // no lazy loading - the whole tree is loaded
        // no default active nodes in the tree
        // title is the element type
        var mainJson = `{"key":"` + value_json + `", "icon": false, "lazy": false, "active": false,"title":"` + node.nodeName + `"`
        var jsonForChildNodes = "";

        // if the node has children open the children array
        if (node.childNodes.length > 0) {
            mainJson += `, "children":[`
        }
        for (var i = 0; i < node.childNodes.length; i++) {
            // for each child of the main node generate deeper json objects
            jsonForChildNodes += androidGenerateJSONForTreeFromXML(node.childNodes[i]);
        }
        if (jsonForChildNodes) {
            // close the children array
            mainJson += jsonForChildNodes + `]`
        }
        // close the json object
        mainJson += `}`

        // cus I am a bad developer I couldn't think of the proper way to 
        // build the json with all needed commas so I invented this solution
        // to add the missing commas to make the json valid xD
        mainJson = mainJson.replaceAll("}{", "},{")
        return mainJson;
    }

    // Present the element info table with all the values
    function showElementInfo(json) {
        let selected_device_text = $("#device-dropdown option:selected").text()

        if (selected_device_text.includes("iOS")) {
            $("#element-info-table").css("visibility", "visible")
            $("#element-type").text(json.type)
            $("#element-name").text(json.name)
            $("#element-label").text(json.label)
            $("#element-value").text(json.value)
            $("#element-enabled").text(json.enabled)
            $("#element-visible").text(json.visible)
            $("#element-x").text(json.x)
            $("#element-y").text(json.y)
            $("#element-width").text(json.width)
            $("#element-height").text(json.height)
        } else {
            $("#element-info-table").css("visibility", "visible")
            $("#element-index").text(json.index)
            $("#element-resourceid").text(json.resourceid)
            $("#element-package").text(json.package)
            $("#element-class").text(json.class)
            $("#element-text").text(json.text)
            $("#element-checkable").text(json.checkable)
            $("#element-checked").text(json.checked)
            $("#element-clickable").text(json.clickable)
            $("#element-enabled").text(json.enabled)
            $("#element-focusable").text(json.focusable)
            $("#element-focused").text(json.focused)
            $("#element-long-clickable").text(json.longclickable)
            $("#element-password").text(json.password)
            $("#element-scrollable").text(json.scrollable)
            $("#element-selected").text(json.selected)
            $("#element-bounds").text(json.bounds)
            $("#element-displayed").text(json.displayed)
        }

    }

    // search for elements by locator strategy
    function createElementsDropdown() {
        let session_id;
        let query_type = $('#element-query-type option:selected').val();
        let query_string = $("#element-query").val()
        let found_elements = $('#found-elements-dropdown');

        // clear the dropdown if you already have a search
        found_elements.empty();
        found_elements.prop('selectedIndex', 0);

        // create the json to search for element by locator strategy and value
        let json = JSON.stringify({
            "using": query_type,
            "value": query_string
        })

        // show loading while searching
        $('#loading').css("visibility", "visible");

        let selected_device_text = $("#device-dropdown option:selected").text()
        if (selected_device_text.includes("android")) {
            let appium_port = $("#appium-port").text()
            session_id = $("#appium-session-id").text()
            url = "http://127.0.0.1:" + appium_port + "/wd/hub/session/" + session_id + "/elements"
        } else {
            let wda_url = $("#wda-url").text()
            session_id = $("#wda-session-id").text()
            url = wda_url + "/session/" + session_id + "/elements"
        }

        // call the /elements endpoint with the query
        $.ajax({
            async: true,
            type: "POST",
            data: json,
            contentType: 'application/json',
            url: url,
            success: function (data) {
                $('#loading').css("visibility", "hidden");
                if (data.value.length == 0) {
                    // if response is success but no elements - show no elements in dropdown
                    found_elements.append($('<option></option>').text("No elements found"));
                    $("#found-elements-dropdown").css("visibility", "visible")
                } else {
                    // if response is success and has elements - build the dropdown with their session ids
                    found_elements.append('<option>Choose element</option>');
                    for (let i = 0; i < data.value.length; i++) {
                        $('#loading').css("visibility", "hidden");
                        found_elements.append($('<option></option>').attr('value', data.value[i].ELEMENT).text(data.value[i].ELEMENT));
                        $("#found-elements-dropdown").css("visibility", "visible")
                    }
                }
            },
            error: function () {
                // show could not get elements if something is wrong with the request
                $('#loading').css("visibility", "hidden");
                found_elements.append($('<option></option>').text("Could not get elements"));
                $("#found-elements-dropdown").css("visibility", "visible")
            }
        });
    }

    // Tap element from found elements dropdown
    function tapElement() {
        let wda_url = $("#wda-url").text()
        let wda_session_id = $("#wda-session-id").text()
        let element_id = $('#found-elements-dropdown option:selected').val();

        /* Show loading indicator until response is returned */
        $('#loading').css("visibility", "visible");

        // call the click endpoint using the element id from the dropdown
        $.ajax({
            async: true,
            type: "POST",
            data: "{}",
            url: wda_url + "/session/" + wda_session_id + "/element/" + element_id + "/click",
            success: function () {
                $('#loading').css("visibility", "hidden");
            },
            error: function () {
                $('#loading').css("visibility", "hidden");
            }
        });
    }

    //=============CANVAS INTERACTIONS===================//
    // canvas over the WDA image stream that allows us to tap
    // and also draw element rectangles
    var canvas = document.getElementById("actions-canvas")

    var tapStartAt = 0
    var coord1;
    var coord2;

    canvas.addEventListener('mousedown', () => {
        // get the time of clicking the canvas
        tapStartAt = (new Date()).getTime()
        // get the initial coordinates of clicking the canvas
        coord1 = getCursorCoordinates(canvas, event)
        applyCursorRippleEffect(event);
        console.log("MOUSE DOWN COORDINATES:" + coord1[0] + "-" + coord1[1])
    })

    canvas.addEventListener('mouseup', () => {
        // get the coordinates on finishing the click on the canvas
        coord2 = getCursorCoordinates(canvas, event)
        console.log("MOUSE DOWN COORDINATES:" + coord2[0] + "-" + coord2[1])
        // get the time of finishing the click on the canvas
        var tapEndAt = (new Date()).getTime()

        var mouseEventsTimeDiff = tapEndAt - tapStartAt

        // if the difference of time between click down and click up is more than 500ms assume it is a swipe, not a tap
        // to allow flick swipes we also check the difference between the gesture coordinates
        // x1, y1 = mousedown coordinates
        // x2, y2 = mouseup coordinates
        // if x2 > x1*1.1 - it is probably a swipe left to right
        // if x2 < x1*0.9 - it is probably a swipe right to left
        // if y2 < y1*0.9 - it is probably a swipe bottom to top
        // if y2 > y1*1.1 - it is probably a swipe top to bottom
        if (mouseEventsTimeDiff > 500 || coord2[0] > coord1[0] * 1.1 || coord2[0] < coord1[0] * 0.9 || coord2[1] < coord1[1] * 0.9 || coord2[1] > coord1[1] * 1.1) {
            performSwipe(coord1, coord2)
        } else {
            // else perform a simple tap at coordinates
            tapCoordinates(coord1)
        }
    })

    // remove anything drawn on the canvas
    function clearCanvas() {
        const canvas = document.getElementById('actions-canvas')
        const context = canvas.getContext('2d')
        context.clearRect(0, 0, canvas.width, canvas.height);
    }

    // draw rectangle on the canvas for element found by search for element
    function drawRectangle() {
        let session_id;
        let element_id = $("#found-elements-dropdown").val();

        // clear the canvas before drawing a new object
        clearCanvas()
        const canvas = document.getElementById('actions-canvas')
        const context = canvas.getContext('2d')
        context.fillStyle = "rgba(232, 226, 63, 0.5)";

        // get stream size and ratio
        let stream_height = $("#actions-canvas").height()
        let stream_width = $("#actions-canvas").width()
        let stream_size_ratio = (stream_height / stream_width).toFixed(2)

        // get device screen size dimensions
        let deviceSize = $("#device-size").text()
        let dimensions = deviceSize.split('x');
        let device_height = parseInt(dimensions[1], 10)
        let device_width = parseInt(dimensions[0], 10)

        // get the selected element coordinates and width/height from the json
        let elementX;
        let elementY;
        let elementWidth;
        let elementHeight;

        // Get the selected container device name to check if android or iOS
        let selected_device_text = $("#device-dropdown option:selected").text()
        var url;

        if (selected_device_text.includes("android")) {
            let appium_port = $("#appium-port").text()
            session_id = $("#appium-session-id").text()
            url = "http://127.0.0.1:" + appium_port + "/wd/hub/session/" + session_id + "/element/" + element_id + "/rect"
        } else {
            let wda_url = $("#wda-url").text()
            session_id = $("#wda-session-id").text()
            url = wda_url + "/session/" + session_id + "/element/" + element_id + "/rect"
        }
        // get the coordinates of the selected element by the element ID generated by Appium
        $.ajax({
            async: false,
            type: "GET",
            url: url,
            success: function (data) {
                elementX = data.value.x
                elementY = data.value.y
                elementWidth = data.value.width
                elementHeight = data.value.height
            }
        });

        // If the stream height is different than the device screen height
        // Recalculate the element coordinates and width/height
        if (stream_height != device_height) {
            elementX = (elementX / device_width) * stream_width
            elementY = (elementY / device_height) * stream_height
            elementWidth = (elementWidth / device_width) * stream_width
            elementHeight = (elementHeight / device_height) * stream_height

            // draw the rectangle on the canvas using the recalculated element values
            context.fillRect(
                elementX,
                elementY,
                elementWidth,
                elementHeight
            );
        } else {
            // if the stream height is the same as the device screen height just draw the rectangle with the original values
            context.fillRect(
                elementX,
                elementY,
                elementWidth,
                elementHeight
            );
        }
    }

    // draw a rectangle for element selected by the app source tree
    // get the element coordinates and size from fancytree node value and build a rectangle on the stream canvas
    // showing the selected element
    function drawRectangleForTree(json) {
        // clear the canvas before drawing a new object
        clearCanvas()
        const canvas = document.getElementById('actions-canvas')
        const context = canvas.getContext('2d')
        context.fillStyle = "rgba(232, 226, 63, 0.5)";

        // get stream size and ratio
        let stream_height = $("#actions-canvas").height()
        let stream_width = $("#actions-canvas").width()
        let stream_size_ratio = (stream_height / stream_width).toFixed(2)

        // get device screen size dimensions
        let deviceSize = $("#device-size").text()
        let dimensions = deviceSize.split('x');
        let device_height = parseInt(dimensions[1], 10)
        let device_width = parseInt(dimensions[0], 10)

        let elementX;
        let elementY;
        let elementWidth;
        let elementHeight;
        let appium_height;

        let selected_device_text = $("#device-dropdown option:selected").text()
        if (selected_device_text.includes("iOS")) {
            // get the selected element coordinates and width/height from the json
            elementX = json.x;
            elementY = json.y;
            elementWidth = json.width;
            elementHeight = json.height;
        } else {
            // Get the bounds which are two separate arrays next to each other
            let element_bounds = json.bounds

            // Change the initial bounds string into two values separated by :
            let element_bounds_no_brackets = element_bounds.replaceAll("][", ":").replaceAll("[", "").replaceAll("]", "")

            // Split the separated values into two different arrays
            let bounds_array = element_bounds_no_brackets.split(":")

            // Get the start coordinates from the first bounds array index into their own array
            let start_coordinates = bounds_array[0].split(",")

            // Get the end coordinates from the second bounds array index into their own array
            let end_coordinates = bounds_array[1].split(",")

            // Set the element actual coordinates based on the final arrays
            // Element starting X is the first value of the first array
            elementX = start_coordinates[0]
            // Element starting Y is the second value of the first array
            elementY = start_coordinates[1]
            // Element width is equal to the ending X coordinate from the second array minus the starting X coordinate from the first array
            elementWidth = end_coordinates[0] - start_coordinates[0]
            // Element height is equal to the ending Y coordinate from the second array minus the starting Y coordinate from the first array
            elementHeight = end_coordinates[1] - start_coordinates[1]
        }

        // If the stream height is different than the device screen height
        // Recalculate the element coordinates and width/height
        if (stream_height != device_height) {

            elementX = (elementX / device_width) * stream_width
            elementY = (elementY / device_height) * stream_height
            elementWidth = (elementWidth / device_width) * stream_width
            elementHeight = (elementHeight / device_height) * stream_height

            // draw the rectangle on the canvas using the recalculated element coordinate values
            context.fillRect(
                elementX,
                elementY,
                elementWidth,
                elementHeight
            );
        } else {
            // if the stream height is the same as the device screen height just draw the rectangle with the original values
            context.fillRect(
                elementX,
                elementY,
                elementWidth,
                elementHeight
            );
        }
    }

    function performSwipe(coord1, coord2) {
        let selected_device_text = $("#device-dropdown option:selected").text()

        var firstCoordX = coord1[0]
        var firstCoordY = coord1[1]
        var secondCoordX = coord2[0]
        var secondCoordY = coord2[1]

        // get stream size and ratio
        let stream_height = $("#actions-canvas").height()
        let stream_width = $("#actions-canvas").width()
        let stream_size_ratio = (stream_height / stream_width).toFixed(2)

        // get device screen size dimensions
        let deviceSize = $("#device-size").text()
        let dimensions = deviceSize.split('x');
        let deviceHeight = parseInt(dimensions[1], 10)
        let deviceWidth = parseInt(dimensions[0], 10)

        // if the stream height 
        if (stream_height != deviceHeight) {
            firstCoordX = (firstCoordX / stream_width) * deviceWidth
            firstCoordY = (firstCoordY / stream_height) * deviceHeight
            secondCoordX = (secondCoordX / stream_width) * deviceWidth
            secondCoordY = (secondCoordY / stream_height) * deviceHeight
        }

        let jsonData = JSON.stringify({
            "actions": [
                {
                    "type": "pointer",
                    "id": "finger1",
                    "parameters": {
                        "pointerType": "touch"
                    },
                    "actions": [
                        {
                            "type": "pointerMove",
                            "duration": 0,
                            "x": firstCoordX,
                            "y": firstCoordY
                        },
                        {
                            "type": "pointerDown",
                            "button": 0
                        },
                        {
                            "type": "pointerMove",
                            "duration": 750,
                            "origin": "viewport",
                            "x": secondCoordX,
                            "y": secondCoordY
                        },
                        {
                            "type": "pointerUp",
                            "button": 0
                        }
                    ]
                }
            ]
        })

        let session_id;
        if (selected_device_text.includes("android")) {
            let appium_port = $("#appium-port").text()
            session_id = $("#appium-session-id").text()
            url = "http://127.0.0.1:" + appium_port + "/wd/hub/session/" + session_id + "/actions"
        } else {
            let wda_url = $("#wda-url").text()
            session_id = $("#wda-session-id").text()
            url = wda_url + "/session/" + session_id + "/actions"
        }

        // call the /actions endpoint sending the tapp coordinates
        // on response remove the canvas loader
        $.ajax({
            type: "POST",
            contentType: 'application/json',
            data: jsonData,
            url: url,
            success: function () {
            },
            error: function () {
                alert("WDA session is invalid, please reload")
            }
        });
    }

    // get the coordinates of the cursor position of the canvas tap event
    function getCursorCoordinates(canvas, event) {
        // get the canvas rectangle and then the coordinates of the tap event
        const rect = canvas.getBoundingClientRect()
        const x = event.clientX - rect.left
        const y = event.clientY - rect.top
        return [x, y];
    }

    // tap with WDA using coordinates
    function tapCoordinates(pos) {
        let selected_device_text = $("#device-dropdown option:selected").text()

        // get stream size and ratio
        let stream_height = $("#actions-canvas").height()
        let stream_width = $("#actions-canvas").width()
        let stream_size_ratio = (stream_height / stream_width).toFixed(2)

        // get device screen size dimensions
        let deviceSize = $("#device-size").text()
        let dimensions = deviceSize.split('x');
        let deviceHeight = parseInt(dimensions[1], 10)
        let deviceWidth = parseInt(dimensions[0], 10)

        // set initial x and y tap coordinates
        let x = pos[0]
        let y = pos[1]

        // if the stream height 
        if (stream_height != deviceHeight) {
            x = (pos[0] / stream_width) * deviceWidth
            y = (pos[1] / stream_height) * deviceHeight
        }

        // build the json accepted by the /actions Appium endpoint used by the Appium Inspector
        let jsonData = JSON.stringify({
            "actions": [
                {
                    "type": "pointer",
                    "id": "finger1",
                    "parameters": {
                        "pointerType": "touch"
                    },
                    "actions": [
                        {
                            "type": "pointerMove",
                            "duration": 0,
                            "x": x,
                            "y": y
                        },
                        {
                            "type": "pointerDown",
                            "button": 0
                        },
                        {
                            "type": "pause",
                            "duration": 200
                        },
                        {
                            "type": "pointerUp",
                            "button": 0
                        }
                    ]
                }
            ]
        })

        let session_id;
        if (selected_device_text.includes("android")) {
            let appium_port = $("#appium-port").text()
            session_id = $("#appium-session-id").text()
            url = "http://127.0.0.1:" + appium_port + "/wd/hub/session/" + session_id + "/actions"
        } else {
            let wda_url = $("#wda-url").text()
            session_id = $("#wda-session-id").text()
            url = wda_url + "/session/" + session_id + "/actions"
        }

        // call the /actions endpoint sending the tapp coordinates
        // on response remove the canvas loader
        $.ajax({
            type: "POST",
            contentType: 'application/json',
            data: jsonData,
            url: url,
            success: function () {
            },
            error: function () {
                alert("WDA session is invalid, please reload")
            }
        });
    }

    function applyCursorRippleEffect(e) {
        const ripple = document.createElement("div");

        ripple.className = "ripple";
        document.body.appendChild(ripple);

        ripple.style.left = `${e.clientX}px`;
        ripple.style.top = `${e.clientY}px`;

        ripple.style.animation = "ripple-effect .2s  linear";
        ripple.onanimationend = () => document.body.removeChild(ripple);
    }

    // present a loader and semi-transparent overlay on the canvas while waiting for the tap response
    // block canvas interaction while waiting
    function showCanvasLoader() {
        const canvas = document.getElementById('actions-canvas')
        const context = canvas.getContext('2d')
        context.fillStyle = "rgba(204, 201, 194, 0.4)";
        context.fillRect(0, 0, canvas.width, canvas.height);
        $('#actions-canvas').css("cursor: not-allowed;pointer-events: none;")
        $('#small-loader-image').css("visibility", "visible");
    }

    // remove the canvas loader
    // and allow canvas interactions again
    function hideCanvasLoader() {
        clearCanvas()
        $('#small-loader-image').css("visibility", "hidden");
        $('#actions-canvas').css("cursor: allowed;pointer-events: all;")
    }

</script>

</html>